<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å®¶è¨ˆç°¿ & ã‚«ãƒ­ãƒªãƒ¼ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px;
      background: #f8fafc;
      color: #0f172a;
      line-height: 1.5;
    }
    h1 {
      margin-bottom: 8px;
      font-size: 24px;
    }
    p.page-lead {
      margin-top: 0;
      color: #475569;
    }
    .control-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      padding: 12px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(15, 23, 42, 0.08);
      margin-bottom: 16px;
    }
    .control-panel label {
      display: flex;
      flex-direction: column;
      font-size: 13px;
      color: #475569;
    }
    .control-panel input,
    .control-panel select {
      margin-top: 4px;
      padding: 6px 8px;
      border: 1px solid #cbd5f5;
      border-radius: 8px;
      font-size: 14px;
      min-width: 120px;
    }
    .control-panel button {
      border: none;
      background: #2563eb;
      color: #fff;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
      align-self: flex-end;
    }
    .control-panel button:hover {
      background: #1d4ed8;
    }
    .layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }
    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .calendar-card,
    .entry-card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
    }
    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-weight: 600;
    }
    table.calendar-grid {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    table.calendar-grid th,
    table.calendar-grid td {
      border: 1px solid #e2e8f0;
      padding: 4px;
      vertical-align: top;
      min-height: 90px;
      background: #fff;
    }
    table.calendar-grid th {
      text-align: center;
      background: #eef2ff;
      color: #475569;
      font-size: 13px;
    }
    td.day-cell {
      cursor: pointer;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    td.day-cell:hover {
      background: #eff6ff;
    }
    td.day-cell.selected {
      border: 2px solid #2563eb;
      background: #e0ecff;
    }
    td.day-cell .day-number {
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 4px;
    }
    .cell-entries {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .cell-entries li {
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
      padding: 2px 4px;
      background: #f1f5f9;
      border-radius: 6px;
      color: #0f172a;
    }
    .entry-card h2 {
      margin-top: 0;
      margin-bottom: 4px;
      font-size: 18px;
    }
    .selected-date-label {
      font-weight: 600;
      color: #1d4ed8;
      margin-bottom: 8px;
    }
    .json-instruction {
      font-size: 13px;
      color: #475569;
      background: #f1f5f9;
      padding: 8px 12px;
      border-radius: 10px;
      margin-bottom: 12px;
    }
    .json-editor textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      padding: 10px 12px;
      border: 1px solid #cbd5f5;
      border-radius: 12px;
      font-family: "JetBrains Mono", "Roboto Mono", Consolas, monospace;
      font-size: 13px;
      line-height: 1.5;
      background: #0f172a;
      color: #e2e8f0;
    }
    .json-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
    }
    .json-actions button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    #saveJsonButton {
      background: #16a34a;
      color: #fff;
      font-weight: 600;
    }
    #saveJsonButton:hover {
      background: #15803d;
    }
    #formatJsonButton {
      background: #dbeafe;
      color: #1d4ed8;
      font-weight: 600;
    }
    #formatJsonButton:hover {
      background: #bfdbfe;
    }
    #clearDayButton {
      background: #e2e8f0;
      color: #0f172a;
    }
    #clearDayButton:hover {
      background: #cbd5f5;
    }
    .json-status {
      font-size: 12px;
      color: #475569;
      margin-bottom: 12px;
    }
    .json-status.error {
      color: #dc2626;
    }
    .json-preview {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      max-height: 260px;
      overflow: auto;
    }
    .json-preview h3 {
      margin: 0 0 8px;
      font-size: 14px;
    }
    .json-preview pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-all;
      font-family: "JetBrains Mono", "Roboto Mono", Consolas, monospace;
      font-size: 12px;
      color: #0f172a;
    }
    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 12px;
      color: #475569;
      margin-top: 8px;
    }
    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #f1f5f9;
      padding: 2px 8px;
      border-radius: 999px;
    }
    .cell-summary-badge {
      font-size: 10px;
      color: #475569;
      background: #dbeafe;
      border-radius: 999px;
      padding: 0 6px;
    }
    .viewer-card {
      margin-top: 20px;
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
    }
    .viewer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .viewer-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-end;
    }
    .viewer-controls label {
      display: flex;
      flex-direction: column;
      font-size: 12px;
      color: #475569;
    }
    .viewer-controls input,
    .viewer-controls select {
      margin-top: 4px;
      padding: 6px 8px;
      border: 1px solid #cbd5f5;
      border-radius: 8px;
      font-size: 13px;
      min-width: 120px;
    }
    .viewer-controls button {
      border: none;
      background: #0ea5e9;
      color: #fff;
      padding: 10px 16px;
      border-radius: 999px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .viewer-controls button:hover {
      background: #0284c7;
    }
    .viewer-config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }
    .viewer-config-panel h3 {
      margin: 0 0 6px;
      font-size: 14px;
    }
    .viewer-config-panel textarea {
      width: 100%;
      min-height: 180px;
      resize: vertical;
      padding: 10px 12px;
      border: 1px solid #cbd5f5;
      border-radius: 12px;
      font-family: "JetBrains Mono", "Roboto Mono", Consolas, monospace;
      font-size: 12px;
      background: #0f172a;
      color: #e2e8f0;
    }
    .viewer-status {
      font-size: 12px;
      color: #475569;
      margin-top: 6px;
    }
    .viewer-status.error {
      color: #dc2626;
    }
    .viewer-calendar-container {
      margin-top: 12px;
      overflow-x: auto;
    }
    .viewer-highlighted {
      box-shadow: inset 0 0 0 2px rgba(14, 165, 233, 0.8);
    }
    /* --- è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ«: æŠ˜ã‚Šç•³ã¿æ©Ÿèƒ½ç”¨ --- */
    .toggle-btn {
      cursor: pointer;
      color: #2563eb;
      margin-right: 4px;
      user-select: none;
      font-weight: bold;
      font-family: monospace;
    }
    .toggle-btn:hover {
      color: #1d4ed8;
    }
    .sub-list {
      display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤º */
      padding-left: 8px;
      margin: 0;
      list-style: none;
      border-left: 2px solid #e2e8f0;
    }
    .sub-list.open {
      display: block; /* openã‚¯ãƒ©ã‚¹ãŒã¤ã„ãŸã‚‰è¡¨ç¤º */
    }
    .sub-list li {
      font-size: 10px;
      color: #64748b;
      background: transparent;
      padding: 1px 0;
    }
  </style>
</head>
<body>
  <header>
    <h1>å®¶è¨ˆç°¿ & ã‚«ãƒ­ãƒªãƒ¼ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
    <p class="page-lead">ã‚»ãƒ«ã‚’é¸æŠã—ã¦ã€ãã®æ—¥ã®JSONã‚’ç›´æ¥ç·¨é›†ã§ãã¾ã™ã€‚ãƒ¬ã‚·ãƒ¼ãƒˆã‚„ã‚«ãƒ­ãƒªãƒ¼ã€è‡ªç”±ãƒ¡ãƒ¢ã‚’å¥½ããªæ§‹é€ ã§ç®¡ç†ã—ã¦ãã ã•ã„ã€‚</p>
  </header>

  <section class="control-panel">
    <label>
      å¹´
      <input type="number" id="yearInput" min="1900" max="9999">
    </label>
    <label>
      æœˆ
      <select id="monthInput"></select>
    </label>
    <label>
      é€±ã®é–‹å§‹æ›œæ—¥
      <select id="startWeekdayInput">
        <option value="0">æ—¥æ›œæ—¥</option>
        <option value="1">æœˆæ›œæ—¥</option>
      </select>
    </label>
    <button id="buildButton">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°</button>
  </section>

  <div class="layout">
    <section class="calendar-card">
      <div class="calendar-header">
        <span id="calendarTitle"></span>
        <div class="legend">
          <span>ğŸ§¾ ãƒ¬ã‚·ãƒ¼ãƒˆ</span>
          <span>ğŸ”¥ ã‚«ãƒ­ãƒªãƒ¼</span>
          <span>âœï¸ ãƒ¡ãƒ¢</span>
        </div>
      </div>
      <table class="calendar-grid">
        <thead>
          <tr id="weekdayHeader"></tr>
        </thead>
        <tbody id="calendarBody"></tbody>
      </table>
    </section>

    <section class="entry-card">
      <h2>æ—¥åˆ¥JSON</h2>
      <div class="selected-date-label" id="selectedDateLabel">æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      <div class="json-instruction">
        ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ JSONã‚’ç·¨é›† â†’ ä¿å­˜ã€‚é…åˆ—ã§ã‚‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚è‡ªç”±ã«è¨˜è¿°ã§ãã¾ã™ã€‚æ•´å½¢ã‚„ãƒªã‚»ãƒƒãƒˆã‚‚ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã™ã€‚
      </div>
      <div class="json-editor">
        <textarea id="jsonEditor" spellcheck="false" placeholder='{"receipt":[{"label":"æ˜¼é£Ÿ","amount":1200}],"calorie":1800,"memo":"æ§ãˆã‚"}'></textarea>
      </div>
      <div class="json-actions">
        <button id="saveJsonButton" type="button">ã“ã®æ—¥ã®JSONã‚’ä¿å­˜</button>
        <button id="formatJsonButton" type="button">æ•´å½¢ã—ã¦èª­ã¿ã‚„ã™ã</button>
        <button id="clearDayButton" type="button">ã“ã®æ—¥ã®JSONã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div id="jsonStatus" class="json-status">ç·¨é›†ã™ã‚‹æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
      <div class="json-preview">
        <h3>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
        <pre id="jsonPreview">(ãªã—)</pre>
      </div>
    </section>
  </div>

  <section class="entry-card visual-card">
    <h2>ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¨­å®š</h2>
    <p class="page-lead">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æœ¬ä½“ã®è¦‹ãŸç›®ã‚„ã‚­ãƒ¼ãƒ»å€¤ã«å¿œã˜ãŸç€è‰²ãƒ«ãƒ¼ãƒ«ã‚’ JSON ã§èª¿æ•´ã§ãã¾ã™ã€‚</p>
    <div class="json-instruction">
      ä¾‹: <code>{"highlightRules":{"keyColors":{"receipt":"#e0f2fe"},"valueContains":[{"text":"kcal","color":"#fef9c3"}]}}</code>
    </div>
    <div class="json-editor">
      <textarea id="visualConfigInput" spellcheck="false"></textarea>
    </div>
    <div class="json-actions">
      <button id="applyVisualConfigButton" type="button">è¨­å®šã‚’åæ˜ </button>
      <button id="resetVisualConfigButton" type="button">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™</button>
    </div>
    <div id="visualConfigStatus" class="json-status">å®¶è¨ˆç°¿ãƒ‡ãƒ¼ã‚¿ã¨ã¯åˆ†é›¢ã•ã‚ŒãŸè¦‹ãŸç›®è¨­å®šã§ã™ã€‚</div>
  </section>

  <script src="calendar-algorithms.js"></script>
  <script src="calendar-extensions.js"></script>
  <script src="calendar-core.js"></script>
  <script src="calendar-views.js"></script>
  <script>
    (function () {
      "use strict";

      const WEEKDAYS = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
      const STORAGE_KEY = "kakeibo-calendar-entries";
      const DEFAULT_JSON_TEMPLATE = JSON.stringify({
        receipt: [{ label: "æ˜¼é£Ÿ", amount: 1200 }],
        calorie: 1800,
        memo: "æ§ãˆã‚ã«"
      }, null, 2);

      const DEFAULT_HIGHLIGHT_CONFIG = {
        highlightRules: {
          keyColors: {
            receipt: "#e0f2fe",
            calorie: "#fee2e2",
            memo: "#ecfeff"
          },
          valueContains: [
            { text: "kcal", color: "#fef9c3" },
            { text: "memo", color: "#bbf7d0" }
          ],
          badge: {
            background: "#e2e8f0",
            color: "#334155"
          }
        }
      };

      const state = {
        year: 0,
        month: 0,
        startWeekday: 0,
        selectedDay: null,
        entries: {},
        visualConfig: DEFAULT_HIGHLIGHT_CONFIG
      };

      const yearInput = document.getElementById("yearInput");
      const monthInput = document.getElementById("monthInput");
      const startWeekdayInput = document.getElementById("startWeekdayInput");
      const buildButton = document.getElementById("buildButton");
      const weekdayHeader = document.getElementById("weekdayHeader");
      const calendarBody = document.getElementById("calendarBody");
      const calendarTitle = document.getElementById("calendarTitle");
      const selectedDateLabel = document.getElementById("selectedDateLabel");
      const jsonEditor = document.getElementById("jsonEditor");
      const saveJsonButton = document.getElementById("saveJsonButton");
      const formatJsonButton = document.getElementById("formatJsonButton");
      const jsonStatus = document.getElementById("jsonStatus");
      const jsonPreview = document.getElementById("jsonPreview");
      const clearDayButton = document.getElementById("clearDayButton");
      const visualConfigInput = document.getElementById("visualConfigInput");
      const visualConfigStatus = document.getElementById("visualConfigStatus");
      const applyVisualConfigButton = document.getElementById("applyVisualConfigButton");
      const resetVisualConfigButton = document.getElementById("resetVisualConfigButton");

      function initSelectors() {
        const now = new Date();
        for (let m = 1; m <= 12; m++) {
          const option = document.createElement("option");
          option.value = m;
          option.textContent = m + "æœˆ";
          monthInput.appendChild(option);
        }
        state.year = now.getFullYear();
        state.month = now.getMonth() + 1;
        state.startWeekday = 0;
        state.selectedDay = now.getDate();
        yearInput.value = state.year;
        monthInput.value = String(state.month);
        startWeekdayInput.value = String(state.startWeekday);
      }

      function loadEntries() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === "object") {
              Object.keys(parsed).forEach(function (key) {
                if (typeof parsed[key] === "string") {
                  state.entries[key] = parsed[key];
                } else {
                  state.entries[key] = JSON.stringify(parsed[key], null, 2);
                }
              });
            }
          }
        } catch (error) {
          console.warn("Failed to load entries", error);
          state.entries = {};
        }
      }

      function saveEntries() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state.entries));
        } catch (error) {
          console.warn("Failed to save entries", error);
        }
      }

      function mergeDeep(target, source) {
        Object.keys(source || {}).forEach(function (key) {
          const value = source[key];
          if (value && typeof value === "object" && !Array.isArray(value)) {
            if (!target[key] || typeof target[key] !== "object" || Array.isArray(target[key])) {
              target[key] = {};
            }
            mergeDeep(target[key], value);
          } else if (Array.isArray(value)) {
            target[key] = value.slice();
          } else {
            target[key] = value;
          }
        });
        return target;
      }

      function parseVisualConfigInput() {
        try {
          const parsed = JSON.parse(visualConfigInput.value || "{}");
          const merged = JSON.parse(JSON.stringify(DEFAULT_HIGHLIGHT_CONFIG));
          if (parsed && typeof parsed === "object") {
            mergeDeep(merged, parsed);
          }
          state.visualConfig = merged;
          visualConfigStatus.textContent = "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚";
          visualConfigStatus.classList.remove("error");
          return merged;
        } catch (error) {
          visualConfigStatus.textContent = "ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¨­å®šã®JSONã‚’ç¢ºèªã—ã¦ãã ã•ã„: " + error.message;
          visualConfigStatus.classList.add("error");
          state.visualConfig = DEFAULT_HIGHLIGHT_CONFIG;
          return DEFAULT_HIGHLIGHT_CONFIG;
        }
      }

      function valueMatchesRule(value, rule) {
        if (!rule || !rule.text) return false;
        const stringValue = typeof value === "string" ? value : JSON.stringify(value);
        return stringValue.toLowerCase().includes(String(rule.text).toLowerCase());
      }

      function findHighlightColor(key, value, rules) {
        if (!rules) return null;
        if (rules.keyColors && rules.keyColors[key]) {
          return rules.keyColors[key];
        }
        if (rules.valueContains && rules.valueContains.length > 0) {
          for (let i = 0; i < rules.valueContains.length; i++) {
            if (valueMatchesRule(value, rules.valueContains[i])) {
              return rules.valueContains[i].color;
            }
          }
        }
        return null;
      }

      function applyEntryHighlight(li, key, value) {
        const rules = state.visualConfig && state.visualConfig.highlightRules;
        if (!rules) return;
        const color = findHighlightColor(key, value, rules) || null;
        if (color) {
          li.style.backgroundColor = color;
        }
        const badge = li.querySelector(".cell-summary-badge");
        if (badge && rules.badge) {
          badge.style.backgroundColor = rules.badge.background;
          badge.style.color = rules.badge.color;
        }
      }

      function refreshAllHighlights() {
        document.querySelectorAll("td.day-cell").forEach(function (cell) {
          const dayNumber = Number(cell.dataset.day);
          if (dayNumber) {
            renderCellJsonSummary(dayNumber, cell.querySelector(".cell-entries"));
          }
        });
      }

      function formatDateKey(year, month, day) {
        return [year, month.toString().padStart(2, "0"), day.toString().padStart(2, "0")].join("-");
      }

      function getJsonStringForDay(year, month, day) {
        const key = formatDateKey(year, month, day);
        return state.entries[key] || "";
      }

      function setJsonStringForDay(year, month, day, jsonString) {
        const key = formatDateKey(year, month, day);
        const trimmed = (jsonString || "").trim();
        if (!trimmed) {
          delete state.entries[key];
        } else {
          state.entries[key] = trimmed;
        }
        saveEntries();
      }

      function buildWeekdayHeader() {
        weekdayHeader.innerHTML = "";
        const start = Number(state.startWeekday) || 0;
        for (let i = 0; i < 7; i++) {
          const weekdayIndex = (start + i) % 7;
          const th = document.createElement("th");
          th.textContent = WEEKDAYS[weekdayIndex];
          weekdayHeader.appendChild(th);
        }
      }

      function buildCalendar() {
        state.year = Number(yearInput.value) || state.year;
        state.month = Number(monthInput.value) || state.month;
        state.startWeekday = Number(startWeekdayInput.value) || 0;

        const firstDay = new Date(state.year, state.month - 1, 1);
        const daysInMonth = new Date(state.year, state.month, 0).getDate();
        const leadingBlank = (firstDay.getDay() - state.startWeekday + 7) % 7;

        calendarTitle.textContent = state.year + "å¹´ " + state.month + "æœˆ";
        buildWeekdayHeader();

        calendarBody.innerHTML = "";
        const totalCells = Math.ceil((leadingBlank + daysInMonth) / 7) * 7;
        let currentDay = 1;

        for (let row = 0; row < totalCells / 7; row++) {
          const tr = document.createElement("tr");
          for (let col = 0; col < 7; col++) {
            const cellIndex = row * 7 + col;
            const td = document.createElement("td");
            if (cellIndex < leadingBlank || currentDay > daysInMonth) {
              td.classList.add("empty-cell");
              tr.appendChild(td);
              continue;
            }
            td.classList.add("day-cell");
            td.dataset.day = String(currentDay);
            const numberEl = document.createElement("div");
            numberEl.className = "day-number";
            numberEl.textContent = currentDay;
            const listEl = document.createElement("ul");
            listEl.className = "cell-entries";
            td.appendChild(numberEl);
            td.appendChild(listEl);
            //td.addEventListener("click", function () {
            //  selectDay(currentDay);
            //});
            // ãã®æ™‚ç‚¹ã® currentDay ã‚’å®šæ•°ã«ã‚³ãƒ”ãƒ¼ã—ã¦å›ºå®šã™ã‚‹
            const fixedDay = currentDay; 
            
            td.addEventListener("click", function () {
              selectDay(fixedDay); // ã‚³ãƒ”ãƒ¼ã—ãŸå®šæ•°ã‚’æ¸¡ã™
            });            
            renderCellJsonSummary(currentDay, listEl);
            if (state.selectedDay === currentDay) {
              td.classList.add("selected");
            }
            currentDay += 1;
            tr.appendChild(td);
          }
          calendarBody.appendChild(tr);
        }

        if (!state.selectedDay || state.selectedDay > daysInMonth) {
          state.selectedDay = null;
        }
        updateSelectedDateLabel();
      }

      function renderCellJsonSummary(day, container) {
        const jsonString = getJsonStringForDay(state.year, state.month, day);
        const target = container || document.querySelector(
          '.day-cell[data-day="' + day + '"] .cell-entries'
        );
        if (!target) return;
        
        target.innerHTML = ""; // ä¸€æ—¦ã‚¯ãƒªã‚¢
        if (!jsonString) return;

        try {
          const parsed = JSON.parse(jsonString);
          
          // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹é…åˆ—ã§ãªã„å ´åˆã¯ãã®ã¾ã¾è¡¨ç¤º
          if (parsed === null || typeof parsed !== "object") {
            const li = document.createElement("li");
            li.textContent = String(parsed);
            applyEntryHighlight(li, "value", parsed);
            target.appendChild(li);
            return;
          }

          // JSONã®ã‚­ãƒ¼ã”ã¨ã«å‡¦ç†
          Object.keys(parsed).forEach(function(key) {
            const value = parsed[key];
            const li = document.createElement("li");
            
            // --- é…åˆ—ã®å ´åˆ: æŠ˜ã‚Šç•³ã¿UIã‚’ä½œæˆ ---
            if (Array.isArray(value)) {
              li.style.display = "block"; // ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹è§£é™¤ã—ã¦ç¸¦ç©ã¿ã«ã™ã‚‹

              // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ (ä¾‹: [+] receipt (2))
              const headerDiv = document.createElement("div");
              headerDiv.style.display = "flex";
              headerDiv.style.alignItems = "center";

              const toggleBtn = document.createElement("span");
              toggleBtn.className = "toggle-btn";
              toggleBtn.textContent = "[+]"; // é–‰ã˜ãŸçŠ¶æ…‹ã®ã‚¢ã‚¤ã‚³ãƒ³
              
              const label = document.createElement("span");
              label.textContent = key + " (" + value.length + ")";
              
              headerDiv.appendChild(toggleBtn);
              headerDiv.appendChild(label);
              li.appendChild(headerDiv);

              // ä¸­èº«ã®ãƒªã‚¹ãƒˆ (åˆæœŸã¯éè¡¨ç¤º)
              const subList = document.createElement("ul");
              subList.className = "sub-list";
              
              value.forEach((item, idx) => {
                const subLi = document.createElement("li");
                // ä¸­èº«ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰ç°¡æ˜“è¡¨ç¤ºã€ãã‚Œä»¥å¤–ãªã‚‰ãã®ã¾ã¾
                let text = "";
                if (item && typeof item === "object") {
                   // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­èº«ã‚’é©å½“ã«é€£çµã—ã¦è¡¨ç¤º (ä¾‹: æ˜¼é£Ÿ: 1200)
                   text = Object.values(item).join(": ");
                } else {
                   text = String(item);
                }
                subLi.textContent =  text;
                applyEntryHighlight(subLi, key, item);
                subList.appendChild(subLi);
              });
              li.appendChild(subList);

              // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ (ãƒãƒ–ãƒªãƒ³ã‚°åœæ­¢ãŒé‡è¦)
              toggleBtn.addEventListener("click", function(e) {
                e.stopPropagation(); // è¦ªã®ã€Œæ—¥ä»˜é¸æŠã€ã‚’ç™ºå‹•ã•ã›ãªã„
                
                const isOpen = subList.classList.toggle("open");
                toggleBtn.textContent = isOpen ? "[-]" : "[+]";
              });

            } 
            // --- é…åˆ—ä»¥å¤–ã®å ´åˆ: é€šå¸¸è¡¨ç¤º ---
            else {
              // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç­‰ã®å ´åˆã®ç°¡æ˜“è¡¨ç¤º
              let valStr = "";
              if (value && typeof value === "object") {
                 valStr = "{" + Object.keys(value).length + "}";
              } else {
                 valStr = String(value);
              }
              li.textContent = key + " : " + valStr;
            }

            applyEntryHighlight(li, key, value);
            target.appendChild(li);
          });

        } catch (error) {
          const li = document.createElement("li");
          li.textContent = "JSONã‚¨ãƒ©ãƒ¼";
          target.appendChild(li);
        }
      }

      function selectDay(day) {
        if (!day) {
          return;
        }
        const previous = document.querySelector("td.day-cell.selected");
        if (previous) {
          previous.classList.remove("selected");
        }
        const target = document.querySelector('td.day-cell[data-day="' + day + '"]');
        if (target) {
          target.classList.add("selected");
        }
        state.selectedDay = day;
        updateSelectedDateLabel();
        refreshJsonEditor();
      }

      function updateSelectedDateLabel() {
        if (!state.selectedDay) {
          selectedDateLabel.textContent = "æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„";
          return;
        }
        selectedDateLabel.textContent = state.year + "å¹´" + state.month + "æœˆ" + state.selectedDay + "æ—¥ã®ãƒ‡ãƒ¼ã‚¿";
      }

      function refreshJsonEditor() {
        if (!jsonEditor) {
          return;
        }
        if (!state.selectedDay) {
          jsonEditor.value = "";
          jsonEditor.disabled = true;
          jsonStatus.textContent = "æ—¥ä»˜ã‚’é¸æŠã™ã‚‹ã¨JSONã‚’ç·¨é›†ã§ãã¾ã™ã€‚";
          jsonStatus.classList.remove("error");
          jsonPreview.textContent = "(ãªã—)";
          return;
        }
        jsonEditor.disabled = false;
        const existing = getJsonStringForDay(state.year, state.month, state.selectedDay);
        jsonEditor.value = existing || DEFAULT_JSON_TEMPLATE;
        jsonStatus.textContent = existing ? "ã“ã®æ—¥ã®JSONã‚’ç·¨é›†ã§ãã¾ã™ã€‚" : "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç·¨é›†ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚";
        jsonStatus.classList.remove("error");
        updatePreviewFromEditor({ save: false });
      }

      function updatePreviewFromEditor(options) {
        options = options || {};
        if (!state.selectedDay) {
          jsonPreview.textContent = "(ãªã—)";
          return;
        }
        const rawText = jsonEditor.value;
        const trimmed = rawText.trim();
        if (!trimmed) {
          jsonPreview.textContent = "(ç©ºã®JSON)";
          jsonStatus.textContent = "ç©ºã®çŠ¶æ…‹ã§ä¿å­˜ã™ã‚‹ã¨ã“ã®æ—¥ã®JSONã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚";
          jsonStatus.classList.remove("error");
          if (options.save) {
            setJsonStringForDay(state.year, state.month, state.selectedDay, "");
            renderCellJsonSummary(state.selectedDay);
          }
          return;
        }
        try {
          const parsed = JSON.parse(trimmed);
          jsonPreview.textContent = JSON.stringify(parsed, null, 2);
          jsonStatus.textContent = options.save ? "âœ… JSONã‚’ä¿å­˜ã—ã¾ã—ãŸ" : "ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ";
          jsonStatus.classList.remove("error");
          if (options.save) {
            setJsonStringForDay(state.year, state.month, state.selectedDay, trimmed);
            renderCellJsonSummary(state.selectedDay);
          }
        } catch (error) {
          jsonPreview.textContent = "(JSONã‚¨ãƒ©ãƒ¼)";
          jsonStatus.textContent = "âš ï¸ JSONã‚¨ãƒ©ãƒ¼: " + error.message;
          jsonStatus.classList.add("error");
        }
      }

      function handleJsonInput() {
        if (!state.selectedDay) {
          return;
        }
        updatePreviewFromEditor({ save: true });
        refreshViewerDataFromEntries();
      }

      function handleSaveJson() {
        if (!state.selectedDay) {
          alert("ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        updatePreviewFromEditor({ save: true });
        refreshAllHighlights();
      }

      function handleFormatJson() {
        if (!state.selectedDay) {
          alert("æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        const trimmed = jsonEditor.value.trim();
        if (!trimmed) {
          jsonStatus.textContent = "ç©ºã®ãŸã‚æ•´å½¢å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
          jsonStatus.classList.remove("error");
          return;
        }
        try {
          const parsed = JSON.parse(trimmed);
          jsonEditor.value = JSON.stringify(parsed, null, 2);
          updatePreviewFromEditor({ save: true });
          refreshAllHighlights();
        } catch (error) {
          jsonStatus.textContent = "âš ï¸ JSONã‚¨ãƒ©ãƒ¼: " + error.message;
          jsonStatus.classList.add("error");
        }
      }

      function handleClearDay() {
        if (!state.selectedDay) {
          alert("ãƒªã‚»ãƒƒãƒˆã™ã‚‹æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        if (!confirm("ã“ã®æ—¥ã®JSONã‚’ç©ºã«ã—ã¾ã™ã‹ï¼Ÿ")) {
          return;
        }
        setJsonStringForDay(state.year, state.month, state.selectedDay, "");
        jsonEditor.value = DEFAULT_JSON_TEMPLATE;
        jsonPreview.textContent = "(ãªã—)";
        jsonStatus.textContent = "ã“ã®æ—¥ã®JSONã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚";
        jsonStatus.classList.remove("error");
        renderCellJsonSummary(state.selectedDay);
        refreshAllHighlights();
      }

      function initializeVisualConfigPanel() {
        if (!visualConfigInput) return;
        visualConfigInput.value = JSON.stringify(DEFAULT_HIGHLIGHT_CONFIG, null, 2);
        parseVisualConfigInput();
      }

      function handleApplyVisualConfig() {
        parseVisualConfigInput();
        refreshAllHighlights();
      }

      function handleResetVisualConfig() {
        visualConfigInput.value = JSON.stringify(DEFAULT_HIGHLIGHT_CONFIG, null, 2);
        parseVisualConfigInput();
        refreshAllHighlights();
      }

      buildButton.addEventListener("click", buildCalendar);
      clearDayButton.addEventListener("click", handleClearDay);
      saveJsonButton.addEventListener("click", handleSaveJson);
      formatJsonButton.addEventListener("click", handleFormatJson);
      jsonEditor.addEventListener("input", handleJsonInput);
      startWeekdayInput.addEventListener("change", buildCalendar);
      yearInput.addEventListener("change", buildCalendar);
      monthInput.addEventListener("change", buildCalendar);
      applyVisualConfigButton.addEventListener("click", handleApplyVisualConfig);
      resetVisualConfigButton.addEventListener("click", handleResetVisualConfig);

      initSelectors();
      loadEntries();
      initializeVisualConfigPanel();
      buildCalendar();
      if (state.selectedDay) {
        selectDay(state.selectedDay);
      } else {
        refreshJsonEditor();
      }
      refreshAllHighlights();
    })();
  </script>
</body>
</html>
